---
title: "CONFETTI without bulk DNA"
author: "Salvatore Milite"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


We try to analyze a glioblastome smart-seq dataset from (Patel et al., 2014). The dataset with the associated BAF is taken from 

```{r exploratory}

load("glioblastoma_TPM.rda")

chr_cnv <- data.frame(chr = names(hg38_karyo), start = rep(1,length(hg38_karyo)), end = hg38_karyo, tot = rep(2, length(hg38_karyo)))

chr_cnv$chr <- paste0("chr", chr_cnv$chr)

express <- get_data(glioblastoma_TPM, cnv_data = chr_cnv, type = "fixed_binning", fun = mean)

pheatmap::pheatmap(express$data$counts, cluster_cols = F,  show_rownames = F)


```

We can see a fairly variagate landscape, with some interesting changes in chromosomes 9,14 and maybe 13. Now let's segment the genome.

```{r}
library(ggpubr)

load("AF.rda")

cov_tr <-  20

good_sites <- which(AF_info$coverage > cov_tr)



MAF <- AF_info$minor[good_sites] / AF_info$coverage[good_sites]


MAF_l <- MAF %>% dplyr::as_tibble(rownames = "pos") %>% tidyr::separate(pos, c("chr", "start"))

res <- segment_genome(MAF_l, steps = 200L, param_list = list('t'=1e-8), filter_size = 25)

segs_df <- from_inference_to_segments(res, MAF_l)

segs_df$tot[segs_df$tot == 5] <- 4

segs_df$tot[segs_df$tot == 3] <- 4
segs_df$tot[segs_df$tot == 6] <- 4



segs_df_corr <- simplify_segs(segs_df)

ggpubr::ggarrange(plot_MAF(MAF_l, k = 5), plot_MAF(MAF_l, k = 25), align = "hv", common.legend = T, labels = c("A", "B"), legend = "none", font.label = list(size = 12))

```


```{r}

segs_df_corr$chr <-  paste0("chr", segs_df_corr$chr)


binned_express_corr <- get_data(glioblastoma_TPM, cnv_data = segs_df_corr, type = "fixed_binning", correct_bins = T, fun = mean, bindim = median, genome = "hg19")

binned_express$data$cnv$ploidy_real <- rep(1,nrow(binned_express$data$cnv))

binned_express <- filter_segments.rcongas(binned_express, filter_mu = 50)

LOH <- grep(binned_express$data$cnv$segment_id, pattern = "chr1[0|3|4]:", value = T, perl = T)

pheatmap::pheatmap(binned_express$data$counts, cluster_cols = F,  show_rownames = F, cluster_rows = T, cutree_rows = 3)
```


```{r}
set.seed(3)
torch <- reticulate::import("torch")

mix_prior <-  list(NULL, torch$tensor(c(0.8,0.2)), torch$tensor(c(0.4,0.3,0.3)), torch$tensor(c(0.3,0.3,0.2,0.2)) )

filt <- apply(binned_express$data$counts,2,sd)

binned_express_most_var <-  binned_express[, filt > quantile(filt, 0.6)]

subclones <- best_cluster(X = binned_express, clusters = 1:4, model = "MixtureGaussianNorm", steps = 800L, lr = 0.05, param_list = list(a = 0, b = 0.8, init_sd = 0.1), method = "AIC", mixture = mix_prior, posteriors = T, step_post = 100) 

```

```{r}
subclones$inference$models[[subclones$inference$model_selection$best_K]]$parameters$norm_factor <- rep(1,75)
subclones$data <-  binned_express$data
plot_counts_rna_segments(subclones, z_score = T, normalised = F)
```

```{r}
#load("MGH31_SNPs_per_cell.rda")

all_cells <- names(get_cluster_assignments(subclones))

normal_cells <- all_cells[get_cluster_assignments(subclones) == 3]
tumor_cells <- all_cells[get_cluster_assignments(subclones) != 3]


ref_normal <- rowSums(MGH31_SNPs_per_cell$ref[,normal_cells])
alt_normal <- rowSums(MGH31_SNPs_per_cell$alt[,normal_cells])
min_normal <- pmin(ref_normal, alt_normal)
maj_normal <- pmax(ref_normal, alt_normal)
cov_normal <- ref_normal + alt_normal

ref_tumor <- rowSums(MGH31_SNPs_per_cell$ref[,tumor_cells])
alt_tumor <- rowSums(MGH31_SNPs_per_cell$alt[,tumor_cells])
min_tumor <- pmin(ref_tumor, alt_tumor)
maj_tumor <- pmax(ref_tumor, alt_tumor)
cov_tumor <- ref_tumor + alt_tumor

filter <- which(cov_normal > 30)

MAF_normal <- min_normal[filter] / cov_normal[filter]
MAF_tumor <- min_tumor[filter] / cov_tumor[filter]

par(mfrow = c(2,1))

plot(y = MAF_tumor[grep(names(MAF_tumor),pattern = "")], as.numeric(do.call(rbind, strsplit(names(MAF_tumor),split = ":"))[,2]))
plot(y = MAF_normal[grep(names(MAF_normal),pattern = "")],as.numeric(do.call(rbind, strsplit(names(MAF_normal),split = ":"))[,2]))
```

```{r}


cov_tr <-  40

good_sites <- which(cov_tumor > cov_tr)



MAF <- min_tumor[good_sites] / cov_tumor[good_sites]

MAF <-  MAF[MAF > 0.10]

MAF <-  MAF[grep(names(MAF), pattern = "chr1[0|4|3]:",invert = T)]

MAF_l <- MAF %>% dplyr::as_tibble(rownames = "pos") %>% tidyr::separate(pos, c("chr", "start"))

res <- segment_genome(MAF_l, steps = 200L, param_list = list('t' =1e-8), filter_size = 33)

segs_df <- from_inference_to_segments(res, MAF_l)

segs_df$tot[segs_df$tot == 6] <- 2

segs_df$tot[segs_df$tot == 5] <- 4


segs_df_corr2 <- simplify_segs(segs_df)

ggpubr::ggarrange(plot_MAF(MAF_l, k = 5), plot_MAF(MAF_l, k = 11), align = "hv", common.legend = T, labels = c("A", "B"), legend = "none", font.label = list(size = 12))

```

```{r}
segs_df_corr2$chr <-  paste0("chr", segs_df_corr2$chr)

binned_express2 <- get_data(glioblastoma_TPM[,tumor_cells], cnv_data = segs_df_corr2, type = "fixed_binning", correct_bins = F, fun = mean, chrs = paste0("chr", 1:22)[-11])



binned_express2$data$cnv$ploidy_real <- rep(1,nrow(binned_express2$data$cnv))

binned_express2 <- filter_segments.rcongas(binned_express2, filter_mu = 50)


final_expr <- bind_rcongas_data(binned_express2, binned_express[tumor_cells,which(colnames(binned_express$data$counts)  %in% LOH)]) 


pheatmap::pheatmap(final_expr$data$counts, cluster_cols = F,  show_rownames = F, cluster_rows = T, cutree_rows = 3)
```

```{r}
set.seed(3)
to_run <- final_expr[tumor_cells,]

filt <- apply(to_run$data$counts,2,sd)

to_run <-  to_run[, filt > quantile(filt, 0.65)]

subclones2 <- best_cluster(to_run, clusters = 1:4, model = "MixtureGaussianNorm", steps = 800L, lr = 0.01, param_list = list(a = 0, b = 1, init_sd = 0.1), method = "AIC", posteriors = T, step_post = 150) 
```


```{r}


plot_counts_rna_segments(subclones2, z_score = T, normalised = F)
```


```{r}

p1 <- MAF_clust_plot(MGH31_SNPs_per_cell$ref, MGH31_SNPs_per_cell$tot_coverage, names(best_model2$parameters$assignement[best_model2$parameters$assignement == 2]) , names(best_model2$parameters$assignement[best_model2$parameters$assignement!= 2]) ,"^5:", filt = 20, labels = c("2", "1"))




```

```{r}

df_norm_tum <-  calculate_DE(subclones, input = glioblastoma_TPM, clone1 = 3, NULL, normalize = F, logfc.threshold = 0.2)
  
df_5_no5 <- calculate_DE(subclones2, input = glioblastoma_TPM[,get_best_model(subclones2)$dim_names$cell_names], clone1 = 2, NULL, normalize = F, logfc.threshold = 0.2)
  
df_14_no14 <- calculate_DE(subclones2, input = glioblastoma_TPM[,get_best_model(subclones2)$dim_names$cell_names], clone1 = 1,3, normalize = F, logfc.threshold = 0.2)


so <- CreateSeuratObject(glioblastoma_TPM[,names(c_fin)])
so <- NormalizeData(so)
so <- FindVariableFeatures(so, selection.method = "vst", nfeatures = 6000)

so <- RunUMAP(so, features = VariableFeatures(object = so))

ump2 <-  as.matrix(ump2)
colnames(ump2) <- paste0("UMAP2_", 1:2)
rownames(ump2) <- rownames(as.matrix(binned_express$counts))

so[["umap2"]] <- CreateDimReducObject(embeddings = as.matrix(ump2), key = "UMAP2_", assay = DefaultAssay(so))

fp <- FeaturePlot(so, features = c("KCNMB4", "CLDN11" ,"MOG" ,"CD63" ,"PSMA7" ,"SOD1" , "EGFR" , "C1S", "SYNE2" ))


so@meta.data$clust1 <-  best_model$parameters$assignement 

nor <- best_model$parameters$assignement[best_model$parameters$assignement == 2]
nor[nor == 2] <- 0
c_fin <- c(nor, best_model2$parameters$assignement )
c_fin[c_fin == 4] <- 1
c_fin <- sort(c_fin)
so@meta.data$clust1 <-  c_fin


so2 <- CreateSeuratObject(glioblastoma_TPM[,best_model2$dim_names$cell_names])
so2@meta.data$clust2  <- best_model2$parameters$assignement 


vp2 <- VlnPlot(so, features = c("KCNMB4", "CLDN11" ,"MOG","CD63" ,"PSMA7" ,"SOD1" , "EGFR" , "C1S", "SYNE2" ),  group.by = "clust1", pt.size = 0.5)
```


